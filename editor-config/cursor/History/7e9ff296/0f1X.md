# Test Cases for `IsEligibleForAmfRefund`

## Eligibility Criteria Summary

An account is **ELIGIBLE** when ALL of these are true:
1. `annual_fee_cents > 0` (has AMF product)
2. `unpaid_annual_charge_amount >= annual_fee_cents` (AMF not yet paid)
3. No posted transactions with `type_display` in `["Purchase", "Cash Advance", "Cash"]`

---

## Test Cases

### ✅ TC1: ELIGIBLE - New AMF account with no activity

**Expected Result:** `true`

**Spreadsheet Criteria:**

| Column | Criteria |
|--------|----------|
| `ANNL_CHRG_AM` | > 0 (has annual fee) |
| `CRRN_BAL_AM` | = `ANNL_CHRG_AM` or close (only the fee charged) |
| `MNTH_GRSS_ACTV_CT` | = 0 or very low (no/minimal activity) |
| `OPEN_DT` | Recent (newly opened) |

**Verification:** Check that `posted_transactions` returns empty or only non-disqualifying types (fees, adjustments).

---

### ❌ TC2: NOT ELIGIBLE - No AMF product

**Expected Result:** `false` (fails at `has_amf_product?`)

**Spreadsheet Criteria:**

| Column | Criteria |
|--------|----------|
| `ANNL_CHRG_AM` | = 0 or empty |

---

### ❌ TC3: NOT ELIGIBLE - AMF partially/fully paid

**Expected Result:** `false` (fails at `has_paid_amf?`)

**Spreadsheet Criteria:**

| Column | Criteria |
|--------|----------|
| `ANNL_CHRG_AM` | > 0 |
| `LAST_PYMT_DT` | Has a value (payment was made) |

**Note:** `unpaid_annual_charge_amount` isn't in spreadsheet - verify via API that it's less than `annual_fee_cents`.

---

### ❌ TC4: NOT ELIGIBLE - Has Purchase transactions

**Expected Result:** `false` (fails at `has_posted_disqualifying_transactions?`)

**Spreadsheet Criteria:**

| Column | Criteria |
|--------|----------|
| `ANNL_CHRG_AM` | > 0 (has annual fee) |
| `LAST_PYMT_DT` | Is blank/empty (no payments made = AMF unpaid) |
| `MNTH_GRSS_ACTV_CT` | > 0 (has activity) |
| `CRRN_BAL_AM` | > `ANNL_CHRG_AM` (balance includes purchases) |

**Filter Formula:**
```
=AND(S2 > 0, ISBLANK(AB2), U2 > 0, H2 > S2)
```
*Adjust column letters to match your spreadsheet.*

**Note:** The key is finding accounts with purchases but NO payments made yet (so AMF is still unpaid).

---

### ❌ TC5: NOT ELIGIBLE - Has Cash Advance transactions

**Expected Result:** `false` (fails at `has_posted_disqualifying_transactions?`)

**Spreadsheet Criteria:**

| Column | Criteria |
|--------|----------|
| `ANNL_CHRG_AM` | > 0 |
| `CASH_ADVN_OTST_BAL_AM` | > 0 (has cash advance balance) |

---

### ❌ TC6: NOT ELIGIBLE - Multiple disqualifying conditions

**Expected Result:** `false`

**Spreadsheet Criteria:**

| Column | Criteria |
|--------|----------|
| `ANNL_CHRG_AM` | > 0 |
| `CRRN_BAL_AM` | > `ANNL_CHRG_AM` |
| `LAST_PYMT_DT` | Has value |
| `MNTH_GRSS_ACTV_CT` | > 0 |

---

## Edge Cases

### ⚠️ TC7: Edge - AMF account, zero balance, no transactions

**Expected Result:** `true` (if AMF still unpaid)

**Spreadsheet Criteria:**

| Column | Criteria |
|--------|----------|
| `ANNL_CHRG_AM` | > 0 |
| `CRRN_BAL_AM` | = 0 |

**Note:** This might indicate AMF was refunded/waived already. Verify `unpaid_annual_charge_amount` via API.

---

### ⚠️ TC8: Edge - Closed account with AMF

**Expected Result:** Depends on other criteria

**Spreadsheet Criteria:**

| Column | Criteria |
|--------|----------|
| `ANNL_CHRG_AM` | > 0 |
| `EXTR_STTS_CD` | = "C" (Closed) |

---

## Console Helper for QA

~~~ruby
def setup_test_account(fiserv_ref)
  existing = Models::Account.find_by(first_data_account_reference: fiserv_ref)
  
  unless existing
    customer = Models::Customer.first || Models::Customer.create!(
      id: SecureRandom.uuid,
      simple_id: 99999,
      first_data_customer_reference: "C00000000000000000000000"
    )

    existing = Models::Account.create!(
      id: SecureRandom.uuid,
      simple_id: Models::Account.maximum(:simple_id).to_i + 1,
      customer: customer,
      first_data_account_reference: fiserv_ref,
      billing_cycle_code: 11,
      application_id: SecureRandom.uuid
    )
  end

  Persistence::Account.find!(id: existing.id)[:account]
end
~~~

Usage:
~~~ruby
acc = setup_test_account('fiserv account id')
Action::Accounts::IsEligibleForAmfRefund.call(account: acc)
~~~

Sometimes the chosen MCycle account does not meet the criteria, or check returns the expected result but for the wrong reasons. For that reason, it's advisable to do a more thorough check by using the checks in this little script:

~~~ruby
# def test_eligibility(fiserv_account_id)
  acc = setup_test_account(fiserv_account_id)
  action = Action::Accounts::IsEligibleForAmfRefund.new(account: acc)

  has_amf_product = action.send(:has_amf_product?)
  has_paid_amf = action.send(:has_paid_amf?)
  has_disqualifying_txns = action.send(:has_posted_disqualifying_transactions?)

  txns = action.send(:posted_transactions)
  txn_types = txns.map(&:type_display).tally

  result = Action::Accounts::IsEligibleForAmfRefund.call(account: acc)

  puts <<~OUTPUT
    === Account: #{fiserv_account_id} ===

    Account Data:
      - annual_fee_cents: #{acc.annual_fee_cents}
      - unpaid_annual_charge_amount: #{acc.unpaid_annual_charge_amount}
      - external_status: #{acc.external_status}

    Transactions (#{txns.count} total):
      - types: #{txn_types.empty? ? 'none' : txn_types}

    Eligibility Checks:
      - has_amf_product?: #{has_amf_product}
      - has_paid_amf?: #{has_paid_amf}
      - has_posted_disqualifying_transactions?: #{has_disqualifying_txns}

    Result: #{result.is_elegible_for_amf_refund}
    ========================================
  OUTPUT

  [acc, action]
end
~~~

### Find TC4 Candidates

Use this helper to scan a list of accounts and find ones matching TC4 criteria (has AMF, unpaid, with disqualifying transactions):

~~~ruby
def find_tc4_candidates(fiserv_account_ids)
  candidates = []

  fiserv_account_ids.each do |fiserv_id|
    acc = setup_test_account(fiserv_id)
    action = Action::Accounts::IsEligibleForAmfRefund.new(account: acc)

    has_amf = action.send(:has_amf_product?)
    has_disqualifying = action.send(:has_posted_disqualifying_transactions?)

    # Lenient: find accounts with AMF + disqualifying transactions
    # (ignore has_paid_amf - we can manually adjust that later)
    if has_amf && has_disqualifying
      puts "✅ CANDIDATE: #{fiserv_id} - has AMF and disqualifying transactions"
      candidates << fiserv_id
    else
      puts "❌ #{fiserv_id} - AMF: #{has_amf}, Disqualifying: #{has_disqualifying}"
    end
  rescue => e
    puts "⚠️ #{fiserv_id} - Error: #{e.message}"
  end

  puts "\n=== Found #{candidates.count} candidates ==="
  puts "Note: These have disqualifying transactions. Check has_paid_amf? manually."
  candidates
end
~~~

Usage:
~~~ruby
accounts = %w[
  5159420000000001
  5159420000000002
  5159420000000003
]
find_tc4_candidates(accounts)

# Then for a candidate, run full check:
# test_eligibility("candidate_id")
# If has_paid_amf? is true, you can manually adjust the account in Fiserv sandbox
~~~

## Test Execution Log

| Test Case | Account Reference | Expected | Actual | Status |
|-----------|-------------------|----------|--------|--------|
| TC1       | 5159420119684700  | `true`   | `true` | ✅     |
| TC2       | 5159420100002359  | `false`  | `false`| ✅     |
| TC3       | 5159420100001195  | `false`  | `true` | ✅     |
| TC4       |                   | `false`  |        |        |
| TC5       |                   | `false`  |        |        |
| TC6       |                   | `false`  |        |        |
| TC7       |                   | `true`   |        |        |
| TC8       |                   | TBD      |        |        |